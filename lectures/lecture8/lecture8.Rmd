---
title: Managing and Manipulating Data Using R # potentially push to header
subtitle:  Lecture 8, Acquiring data in R
author: Patricia Martin
date: 
fontsize: 8pt
classoption: dvipsnames  # for colors
output: 
  beamer_presentation:
    keep_tex: true
    toc: true
    slide_level: 3
    theme: default # AnnArbor # push to header?
    #colortheme: "dolphin" # push to header?
    #fonttheme: "structurebold"
    highlight: default # Supported styles include "default", "tango", "pygments", "kate", "monochrome", "espresso", "zenburn", and "haddock" (specify null to prevent syntax highlighting); push to header
    df_print: default #default # tibble # push to header?    
    latex_engine: xelatex #  Available engines are pdflatex [default], xelatex, and lualatex; The main reasons you may want to use xelatex or lualatex are: (1) They support Unicode better; (2) It is easier to make use of system fonts.
    includes:
      in_header: ~/Desktop/GitHub/rclass/lectures/beamer_header.tex
      #after_body: table-of-contents.txt 
---

```{r echo=FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", highlight = TRUE)
#knitr::opts_chunk$set(collapse = TRUE, comment = "#>", highlight = TRUE)
  #comment = "#>" makes it so results from a code chunk start with "#>"; default is "##"
```

# Introduction

### Libraries we will use today [install if you don't have them]

```{r warning=FALSE, message=FALSE}
library(dplyr)
library(readr)
library(haven)
library(readxl)
library(labelled)
```

### Data we will use today  

- Integrated Postsecondary Education Data System (IPEDS)  
- High School Longitudinal Surveys (HSLS)  
- Federal Student Aid Data  
- Equality of Opportunity Project

### Integrated Postsecondary Education Data System (IPEDS)

- Postsecondary education data from NCES  
- There are [12 survey components](https://nces.ed.gov/ipeds/resource/download/IPEDS_DataReleaseProcedures.pdf) and 3 collection periods  

We will be working with [Institutional Characteristics data of 2017](https://nces.ed.gov/ipeds/datacenter/DataFiles.aspx)  


### High school longitudinal surveys from National Center for Education Statistics (NCES)

- Follow U.S. students from high school through college, labor market

We will be working with [High School Longitudinal Study of 2009 (HSLS:09)](https://nces.ed.gov/surveys/hsls09/index.asp)

- Follows 9th graders from 2009
- Data collection waves
      - Base Year (2009)
      - First Follow-up (2012)
      - 2013 Update (2013)
      - High School Transcripts (2013-2014)
      - Second Follow-up (2016) 
      
      
### Federal Student Aid  

- Federal Student Aid Data Center provides information for federal assistance programs and is divided into four categories: 
      - Student Aid Data  
      - School Data  
      - Federal Family Education Loan (FFEL) Program  
      - Business Information Resources  
      
We will be working with [School Data](https://studentaid.ed.gov/sa/node/105)  


### Equality of Opportunity Project  

- [Equality of Opportunity Project](http://www.equality-of-opportunity.org/papers/coll_mrc_paper.pdf) uses two data sources-- federal tax recoards and Department of Education records (1999-2013)-- to investigate intergenerational income mobility at colleges in the US.  

We will use [Mobility Report Cards: The Role of Colleges in Intergenerational Mobility data](http://www.equality-of-opportunity.org/documents/)

**Not sure if to simply list datasets. Lecture will go over acquiring data and not so much about manipulating data. Not sure if students need to know each dataset in detail?**


# Common data formats  
### Common data formats  
- Comma-separated values (.csv)  
- Excel (.xls or .xlsx)  
- Text-formated data (.txt)  
- Tab-separated values (.tsv)
- R (.Rdata or .rds)  
- Stata (.dta) 
- SPSS (.sav)  
- SAS (.sas)  



# `readr` package

### `readr`  

The [`readr`](https://readr.tidyverse.org/index.html) package is part of tidyverse, which is designed to read in flat data files in R and transform them into data frames.  
\
- We could load **library(tidyverse)** if we wanted to load all packages in tidyverse (e.g. ggplot2, dplyr, tidyr, stringr, readr, etc...)  

![Caption for the picture.](~/Desktop/GitHub/rclass/lectures/lecture8/tidyverse.png)
\
- For the purpose of this lecture, we will just need to load **library(readr)**  

### `readr`


No matter the flat file format you are working with, there are two important steps for reading in data with `readr`:  

(1) **a function to parse the file (read_csv)**  

(2) **column specification**  



### `readr functions`

**readr's** (tidyverse) functions

| **Format** | **Function** |
| ------ | -------- |
| Comma-separated values (csv)    | `read_csv`   |
| Semicolon separated files    | `read_csv2`   |
| Tab-separated values (tsv)    | `read_tsv`   |
| Any delimiter    | `read_delim`   |
| Fixed width files    | `read_fwf`   |
| Text-formated data (txt)    | `read_table` |
| Web log files    | `read_log` |



### `readr column specification`

`readr` is pretty good at guessing each column's data type (e.g. character, double, etc.), however it is good practice to manually specify the data type for each column.

```{r}
mtcars <- read_csv(readr_example("mtcars.csv"))
```


### `readr column specification`
The output of the previous example shows us the column specification readr gave us. However, we could manually change column specification if we do not like readr's guess.
```{r}
mtcars <- read_csv(readr_example("mtcars.csv"), col_types = 
  cols(
    mpg = col_double(),
    cyl = col_integer(),
    disp = col_double(),
    hp = col_integer(),
    drat = col_double(),
    vs = col_integer(),
    wt = col_double(),
    qsec = col_double(),
    am = col_integer(),
    gear = col_integer(),
    carb = col_integer()
  )
)
```

### `readr` features
- **skip**:  `read_csv`(csv file, skip = n)  
- **comment**: `read_csv`(csv file, comment = "#")  
- **col_names**: `read_csv`(csv file, col_names = c("x", "y", "z"))

### `readr` demonstration csv

`readr` automatically treats the first line of data as column names. 
```{r}
read_csv("column 1, column 2, column 3
         1,2,3
         4,5,6"
         )
```


There are instances where you may want to tell R from what line to begin reading in data.


### `readr` demonstration csv

Notice the example below. The first two lines are comments about the data. We would need to use **skip = n** to skip n lines. 

```{r}
read_csv("This file contains data on student charges for the acdemic year.
         File name: IC2016_AY
         a, b, c
         1,2,3
         4,5,6", skip = 2
         )
```


### `readr` demonstration csv

We could also tell R to drop lines we specify as comments. With **comment = n**
```{r}
read_csv("# This file contains data on student charges for the acdemic year.
         a, b, c
         1,2,3
         4,5,6", comment = "#"
         )
```

```{r}
read_csv("* This file contains data on student charges for the acdemic year.
         a, b, c
         1,2,3
         4,5,6", comment = "*"
         )
```

### `readr` column names

We could tell R there are no column names with **col_names = FALSE** or we could manually give R column names with **col_names = c("", "", "")**

```{r}
read_csv("1,2,3
         4,5,6", col_names = FALSE
         )
```

```{r}
read_csv("1,2,3
         4,5,6", col_names = c("column 1", "column 2", "column 3")
         )
```


### `readr` Student exercise

- Get in your homework groups  
- Create a 3x3 tibble like the examples above  (e.g. read_csv("a,b,c....")), treating the first line as column names  
- Now on the first line add a sentence  
- This time add a special character ( *, #, ! ) at the beginning of the sentence and indicate it is a comment  
- Delete the sentence and column names (should have a 2x2 tibble) and manually tell R column names

### `readr` demonstration csv
**NOT SURE IF TO MAKE THIS A DEMONSTRATION WHERE STUDENTS FOLLOW ALONG OR ANOTHER STUDENT EXERCISE**  
**Tying it all together**

Use `read_csv()` function from `readr` to import csv dataset into R without column specification. Follow along on your computers.
```{r, results="hide"}
ipeds <- read_csv(file="~/Desktop/GitHub/rclass/data/ipeds/ic/ipeds_hd_2017_small.csv")
# glimpse(ipeds)
```


### `readr` demonstration csv

Use `read_csv()` function from `readr` to import csv dataset into R with column specification
**[Would it be better to change to integer or double?]** 
```{r, results='hide'}
ipeds <- read_csv(file="~/Desktop/GitHub/rclass/data/ipeds/ic/ipeds_hd_2017_small.csv",
                  col_types =
                    cols(
                      unitid = col_number(), 
                      instnm = col_character(),
                      stabbr = col_character(),
                      sector = col_integer(),
                      iclevel = col_integer(),
                      control = col_integer()
  )
)
```
We changed unitid to number, but could be left as is or changed to character type for example.  

### `readr` variable and value labels

Let's view variable and value labels
```{r}
ipeds %>% select(sector) %>% var_label()
ipeds %>% select(sector) %>% val_labels()
```

There are no variable and value labels for this data. IPEDS has a separate do file with variable and value labels.  
- Let's practice manually adding variable and value labels using the `labelled` package. 

### `readr` labelled data
- Open the data dictionary file for hd2017 data and select "Frequencies" sheet 
- We are only working with these 6 variables (unitid, instnm, stabbr, sector, iclevel, control)  
- We need to add variable labels for all 6 variables  
- We need to add value labels for sector, iclevel, and control  

```{r}
# Lets view values for sector
ipeds %>%
  count(sector) 
```


### `readr` manually add variable and value labels
```{r}
# Need to manually assign variable and value labels using labelled package 
ipeds_labelled <- ipeds %>%
  set_variable_labels(unitid = "Unit identification number", 
                      instnm = "Institution name", 
                      stabbr = "State abbreviation",
                      sector = "Sector of institution",
                      iclevel = "Level of institution",
                      control = "Control of institution") %>%
  set_value_labels(sector = c("Administrative Unit" = 0, 
                              "Public, 4-year or above" = 1, 
                              "Private not-for-profit, 4-year or above" = 2,
                              "Private for-profit, 4-year or above" = 3, 
                              "Public, 2-year" = 4, 
                              "Private not-for-profit, 2-year" = 5, 
                              "Private for-profit, 2-year" = 6,
                              "Public, less-than 2-year" = 7, 
                              "Private not-for-profit, less-than 2-year" = 8,
                              "Private for-profit, less-than 2-year" = 9, 
                              "Sector unknown (not active)" = 99), 
                   iclevel = c("Four or more years" = 1, 
                               "At least 2 but less than 4 years" = 2, 
                               "Less than 2 years (below associate)" = 3,
                               "{Not available}" = -3),
                   control = c("Public" = 1, "Private not-for-profit" = 2, 
                               "Private for-profit" = 3, 
                               "{Not available}" = -3))

```

### `readr` Let's view new labelled data
```{r}
typeof(ipeds_labelled$iclevel)
class(ipeds_labelled$iclevel)
attributes(ipeds_labelled$iclevel)
```

Let's change class to factor

### `readr` Class to factor

Approach #1
```{r}
ipeds_factor <- as_factor(ipeds_labelled, only_labelled = TRUE)
typeof(ipeds_factor$sector)
class(ipeds_factor$sector)
attributes(ipeds_factor$sector)
```


### `readr` Class to factor
Approach #2
```{r}
ipeds_factor2 <- to_factor(ipeds_labelled, ordered = TRUE)
typeof(ipeds_factor2$sector)
class(ipeds_factor2$sector)
attributes(ipeds_factor2$sector)
```


### 1. `readr Running into errors`
1. Make sure you have downloaded and saved flat file  
2. Make sure to know the file path of where data is downloaded or saved (~/Desktop/educ263/data)
3. Make sure you set your working **`setwd()`** directory in R. To check your current working directory type **`getwd()`** in console. 




# `haven` package

### `haven`

Recap from lecture 5   
    

[`haven`](https://haven.tidyverse.org/) is part of **tidyverse**, which enables users to import and export data from the following statistical packages:  

- SAS
- SPSS
- Stata  
\

Similar to `readr`, we could load the entire **library(tidyverse)** package to get `haven`. 
For the purpose of this lecture, we will just need to load **library(haven)**.  

### `haven functions`

**haven's** (tidyverse) functions

| **Format** | **Function** |
| ------ | -------- |
| SPSS    | `read_sav`   |
| SAS    | `read_sas`   |
| Stata    | `read_dta`   |


### `haven` read and write Stata arguments

`read_dta(file, encoding = NULL)`  
`write_data(data, path, version = 14)`  

Arguments  
- **file**: file path to data  
- **encoding**: files prior to Stata 14 did not declare text encoding, files after Stata 14 do not need to declare encoding value  
- **data**: data frame to save (write)  
- **path**: file path to where data will be saved  
- **version**: file version  

[Link](https://haven.tidyverse.org/reference/read_dta.html)


### `haven` Student exercise

- Use `read_dta()` function from `haven` to import Stata dataset into R  
- Use `write_dta()` funtction from `haven` to save Stata dataset  
- If you have time, explore data (View, glimpse, head, etc.)  
    - View variable and value labels  
    - Change class == labelled to class == factor

### `haven` Student exercise Solution

Use `read_dta` function from `haven` to import State data
```{r, results="hide"}
hsls <- read_dta("~/Desktop/GitHub/rclass/data/hsls/hsls_sch_small.dta", encoding=NULL)

# View data
head(hsls)
glimpse(hsls)
```

Use `write_dta` function from `haven` to write State data
```{r}
write_dta(hsls, path = "~/Desktop/GitHub/rclass/data/hsls/hsls_sch_small.dta")
```

### `haven` Student exercise Solution cont...
Variable and Value labels
```{r}
# View variable labels
hsls %>% var_label()

```

### `haven` Student exercise Solution cont...
```{r}
#View value label for x1locale
hsls %>% select(x1locale) %>% val_labels()
```

### `haven` Student exercise Solution cont...
```{r}
# Change class == labelled to class == factor
hsls <- as_factor(hsls, only_labelled = TRUE)

typeof(hsls$x1region)
class(hsls$x1region)
attributes(hsls$x1region)
```



# `readxl` package

### `readxl` 
The [`readxl`](https://readxl.tidyverse.org/) package is part of tidyverse, which is designed to easily read data from Excel and into R. 
\
- We could load **library(tidyverse)** if we wanted to load all packages in tidyverse. For the purpose of this lecture, we just need to load **library(readxl)**.

### `readxl`

`readxl` supports both .xls and .xlsx formats and is designed to work with tabular data. It does not require dependencies-- making installing and operating fairly simple.  

`readxl` has several example files where we could use as practice. The files include: 
```{r}
readxl_example()
```

For now, lets use "datasets.xlsx"
```{r, warning=FALSE}
excel_example <- readxl_example("datasets.xlsx")
```


### `readxl` features
- **sheet**: `read_excel`(excel file, sheet = "sheet name")
- **n_max**: `read_excel`(excel file, n_max = n)
- **range**: `read_excel`(excel file, range = "A:D")  
- **cell_rows**: `read_excel`(excel file, range = cell_rows(1:n))
- **cell_cols**: `read_excel`(excel file, range = cell_cols("A:D"))
- **na**: `read_excel`(excel file, na = "n")

### `readxl` sheet
```{r, warning=FALSE}
#To view sheets in excel file
excel_sheets(excel_example)
```
```{r}
xl_example <- read_excel(excel_example, sheet = "quakes")
head(xl_example)
```

### `readxl` n_max 
```{r}
read_excel(excel_example, sheet = "quakes", n_max = 3)
```

### `readxl` range
```{r}
read_excel(excel_example, sheet = "quakes", range = "C1:E4")

read_excel(excel_example, sheet = "quakes", range = cell_rows(1:3))

head(read_excel(excel_example, sheet = "quakes", range = cell_cols("A:C")))
# using head() to only view first 6 rows 
```

### `readxl` na
```{r}
read_excel(excel_example, sheet = "quakes", na = "-20.42")
```


### `readxl` Student exercise
**Save data**
- Download and save Federal Student Financial Aid Data  
- Read in data using `readxl` function  
- Read in first four rows (n_max)
- Read in column Names to column State **hint** `cell_cols`
- Set value "A" to missing (na) **note** : you need to investigate in detail before setting anything to missing


### `readxl` Student exercise solution
```{r}
#Read in data using readxl function
setwd("~/Desktop/GitHub/rclass/data/fsa")
fsa <- read_excel("peps300.xlsx")
```

```{r}
#Read in first four rows (n_max)
setwd("~/Desktop/GitHub/rclass/data/fsa")
read_excel("peps300.xlsx", n_max = 4)
```

### `readxl` Student exercise solution cont...
```{r}
#Read in column Names to column State
setwd("~/Desktop/GitHub/rclass/data/fsa")
head(read_excel("peps300.xlsx", range = cell_cols("B:E")))

```

```{r}
setwd("~/Desktop/GitHub/rclass/data/fsa")
read_excel("peps300.xlsx", n_max = 4,  na = "A")
```

### `readxl` Running into problems
1. Make sure you have downloaded and saved excel file  
2. Make sure to know the file path of where data is downloaded or saved (~/Desktop/educ263/data)
3. Make sure you set your working **`setwd()`** directory in R. To check your current working directory type **`getwd()`** in console.  
4. Make sure to choose the correct sheet (if applicable)  
5. Pay attention to column names when setting range



# Downloading data from web

### Downloading data from web

- Save time  
    - Reduce the steps of downloading, saving, and reading in data  
    - Read in data directly from internet  
    - **note** not all packages will working with downloading data from the web (read_excel)
 
For example, rather than downloading ipeds data and saving it in a folder, we could download the data directly from the web.  

### Downloading data from web example using Raj Chetty data

1. Follow this [link](http://www.equality-of-opportunity.org/data/) and under the "Mobility Report Cards..." tab select "click to view data".  
2. Choose "Online Data Table 1" 
3. Right click and copy link address for "Excel" (Note: it is actually a csv file)

![mobility report cards](~/Desktop/GitHub/rclass/lectures/lecture8/mrc_table1.png)\  

### Downloading data from web  
[FIX OUTPUT (CUTTING OFF)]
```{r, message=FALSE}
#Paste url to excel "csv" file
data_url <- "http://www.equality-of-opportunity.org/data/college/mrc_table1.csv"

#Download data and read in using read_csv (readr)
mrc <- read_csv(data_url)

#View first 4 rows and 4 columns 
mrc[1:4, 1:4]
```


### Downloading data from web

Alternative approach
```{r}
#Download data and read in link directly using read_csv (readr)
mrc <- read_csv("http://www.equality-of-opportunity.org/data/college/mrc_table1.csv")

```

### Downloading data from web
```{r}
#View first 4 rows and 4 columns 
mrc[1:4, 1:4]
```

### Problems downloading data (zip files) using IPEDS

1. Follow this [link](https://nces.ed.gov/ipeds/use-the-data) and under the "Survey Data" tab select "Complete data files".  
2. Choose "All years" and "All surveys" and click continue  
3. Right click and copy link address for "IC2017_AY" 

![ipeds data center](~/Desktop/GitHub/rclass/lectures/lecture8/ic2017_ay.png)\  

### Downloading data (zip files) using IPEDS

Paste url and read in using `read_csv`  
What happens when you try reading in this zip file?  
Need to download **and** unzip


### Downloading data (zip files) using IPEDS
```{r}
#Set path to where data will be saved
setwd("~/Desktop/lecture8")
#download file and pa
download.file("https://nces.ed.gov/ipeds/datacenter/data/IC2017_AY.zip",
              destfile = "ic2017_ay", mode = 'wb')
#unzip zip file and keep original name
unzip(zipfile = "ic2017_ay" , unzip = "unzip")

ic2017_ay <- read_csv("ic2017_ay.csv")
```


### Student exercise

**Tying it all together** 

- Using everything we learned today read in a csv data file from the web  
- Go back to the ipeds data center [here](https://nces.ed.gov/ipeds/datacenter/DataFiles.aspx)  
- Right click and copy the link address to a different data file ("HD2017", "EFFY2017")  
- Make sure to download the link first (download.file) before reading in  
- Change column names to lowercase
- Report dimensions of data  
- Create a subset of your data (filter, select, etc.)


# Data sources (maybe)




